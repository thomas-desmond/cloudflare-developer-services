---
interface Service {
  name: string;
  description: string;
  docsUrl: string;
  selector: string;  // CSS selector for elements
  highlightType: 'badge' | 'outline' | 'both';  // How to highlight elements
  badgeText?: string;  // Custom badge text if needed
  badgeConfigs: {
    selector: string;  // Specific selector for this badge instance
    tooltip: string;   // Tooltip text for this specific instance
  }[];
}

const services: Service[] = [
  {
    name: "Vectorize",
    description: "Cloudflare's vector database for AI-powered search. Store product descriptions and names as text embeddings in a vector database, and then use the vector database for AI powered search.",
    docsUrl: "https://developers.cloudflare.com/vectorize/",
    selector: ".cf-vectorize",
    highlightType: 'both',
    badgeText: "Vectorize",
    badgeConfigs: [
      {
        selector: ".cf-vectorize",
        tooltip: "Vector search powered by Vectorize"
      }
    ]
  },
  {
    name: "Cloudflare Images",
    description: "Global image delivery and optimization. Cloudflare Images can be used to store images and then serve them in the optimal format for the user's device.",
    docsUrl: "https://developers.cloudflare.com/images/",
    selector: ".cf-image",
    highlightType: 'both',
    badgeText: "Cloudflare Images",
    badgeConfigs: [
      {
        selector: ".cf-image",
        tooltip: "Image delivery powered by Cloudflare Images"
      }
    ]
  },
  {
    name: "D1 - Serverless SQL Database",
    description: "Cloudflare D1 is a fast and reliable database designed for structured data storage and management. It organizes essential information in tables for quick access, ensuring a smooth experience when viewing products, reading reviews, or checking order history",
    docsUrl: "https://developers.cloudflare.com/d1/",
    selector: ".cf-d1",
    highlightType: 'both',
    badgeText: "D1",
    badgeConfigs: [
      {
        selector: ".cf-d1",
        tooltip: "Product details stored and pulled in from D1"
      }
    ]
  },
  {
    name: "Workers - Serverless Compute",
    description: "A dynamic site requires actions beyond just displaying information. Features like 'Add to Cart', applying discounts, and searching for products rely on efficient back-end processing. Cloudflare Workers enable these seamless interactions by validating input, applying pricing rules, personalizing content, and routing requests quickly. This edge computing ensures fast processing, making the site feel immediate and responsive.",
    docsUrl: "https://developers.cloudflare.com/workers/",
    selector: ".cf-workers",
    highlightType: 'both',
    badgeText: "Workers",
    badgeConfigs: [
      {
        selector: ".cf-workers",
        tooltip: "Backend processing powered by Workers"
      }
    ]
  },
  {
    name: "Workers AI",
    description: "Inference as a Service with Serverless GPUs. Workers AI can be used to generate product descriptions, and in this case was used to generate product images.",
    docsUrl: "https://developers.cloudflare.com/workers-ai/",
    selector: ".cf-workersai",
    highlightType: 'both',
    badgeText: "Workers AI",
    badgeConfigs: [
      {
        selector: ".cf-workersai.image",
        tooltip: "Image generated with Workers AI"
      },
      {
        selector: ".cf-workersai.description",
        tooltip: "Product description generated with Workers AI"
      }
    ]
  },
  {
    name: "KV - Key-Value Store",
    description: "Cloudflare's global key-value database. Perfect for caching product data, user preferences, and session information. KV provides fast, low-latency access to data across Cloudflare's global network.",
    docsUrl: "https://developers.cloudflare.com/kv/",
    selector: ".cf-kv",
    highlightType: 'both',
    badgeText: "KV",
    badgeConfigs: [
      {
        selector: ".cf-kv",
        tooltip: "Data caching powered by KV"
      }
    ]
  },
];
---

<aside class="w-80 bg-white border-l border-gray-200 p-6">
  <div class="flex items-center gap-2 mb-8">
    <span class="text-xl">âš¡</span>
    <h2 class="text-lg font-semibold">Powered by Cloudflare</h2>
  </div>
  
  <div class="space-y-4">
    {services.map(service => (
      <div 
        class="p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer"
        data-service={service.name.toLowerCase().replace(/\s+/g, '-')}
        data-active="false"
      >
        <h3 class="text-[#f6821f] font-medium mb-2">{service.name}</h3>
        <div class="cf-service-details" style="display:none">
          <p class="text-sm text-gray-600 mb-3">{service.description}</p>
          <a 
            href={service.docsUrl} 
            target="_blank" 
            rel="noopener noreferrer"
            class="text-[#f6821f] text-sm font-medium hover:underline inline-flex items-center gap-1"
          >
            Learn More
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </a>
        </div>
      </div>
    ))}
  </div>
  
  <div class="mt-8 pt-6 border-t border-gray-200">
    <p class="text-xs text-gray-500">
      Note: This is a demo interface. While these Cloudflare services are highlighted, they are not actually implemented in this demo. This is for demonstration purposes only.
    </p>
  </div>
</aside>

<script define:vars={{ services }}>
  let activeService = null;

  // Function to create a badge with tooltip
  function createBadge(badgeText, tooltip) {
    const badge = document.createElement('div');
    badge.className = 'absolute bg-[#f6821f] text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-lg z-50 group';
    badge.style.bottom = '-8px';
    badge.style.right = '-8px';
    badge.innerHTML = `
      <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      <span>${badgeText}</span>
      <div class="absolute bottom-full right-0 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
        ${tooltip}
      </div>
    `;
    return badge;
  }

  // Function to highlight elements
  function highlightElements(service) {
    const elements = document.querySelectorAll(service.selector);
    elements.forEach(el => {
      // Make sure the element has a relative position for the badge
      if (service.highlightType === 'badge' || service.highlightType === 'both') {
        if (getComputedStyle(el).position === 'static') {
          el.style.position = 'relative';
        }
      }
      
      // Add highlight effect
      if (service.highlightType === 'outline' || service.highlightType === 'both') {
        el.classList.add('ring-2', 'ring-[#f6821f]', 'ring-offset-2', 'transition-all');
      }
      
      // Add badges if needed
      if (service.highlightType === 'badge' || service.highlightType === 'both') {
        // Find matching badge config for this element
        const matchingConfig = service.badgeConfigs.find(config => 
          el.matches(config.selector)
        );
        
        if (matchingConfig && !el.querySelector('.bg-\\[\\#f6821f\\]')) {
          el.appendChild(createBadge(service.badgeText, matchingConfig.tooltip));
        }
      }
    });
  }

  // Function to remove highlights
  function removeHighlights() {
    // Remove outlines
    document.querySelectorAll('.ring-\\[\\#f6821f\\]').forEach(el => {
      el.classList.remove('ring-2', 'ring-[#f6821f]', 'ring-offset-2');
    });
    
    // Remove badges
    document.querySelectorAll('.bg-\\[\\#f6821f\\]').forEach(badge => {
      badge.remove();
    });
  }

  // Add click handlers to service cards
  document.querySelectorAll('[data-service]').forEach(card => {
    card.addEventListener('click', (e) => {
      const target = e.target;
      // Don't trigger if clicking the "Learn More" link
      if (target.closest('a')) return;
      
      const serviceName = card.getAttribute('data-service');
      const service = services.find(s => s.name.toLowerCase().replace(/\s+/g, '-') === serviceName);
      
      if (service) {
        if (activeService === serviceName) {
          // If already active, clear highlights and reset
          removeHighlights();
          activeService = null;
          // Hide all details
          document.querySelectorAll('[data-service]').forEach(c => {
            c.setAttribute('data-active', 'false');
            c.querySelector('.cf-service-details').style.display = 'none';
          });
        } else {
          // Remove any existing highlights
          removeHighlights();
          // Add new highlights
          highlightElements(service);
          activeService = serviceName;
          // Show only the active details
          document.querySelectorAll('[data-service]').forEach(c => {
            if (c.getAttribute('data-service') === serviceName) {
              c.setAttribute('data-active', 'true');
              c.querySelector('.cf-service-details').style.display = '';
            } else {
              c.setAttribute('data-active', 'false');
              c.querySelector('.cf-service-details').style.display = 'none';
            }
          });
        }
      }
    });
  });
</script> 